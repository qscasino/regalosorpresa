<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Regalos de Navidad</title>

  <style>
    :root{
      --bg1:#1a070a;        /* vino oscuro */
      --bg2:#3a0b10;        /* rojo profundo */
      --card:#2a0a10cc;     /* panel */
      --stroke:#ffffff22;
      --text:#ffffff;
      --muted:#ffffffb3;

      --gold:#ffd36a;
      --gold2:#ffb84d;

      --danger:#ff5b6a;
      --ok:#35d07f;

      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --radius: 18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{box-sizing:border-box}
    html,body{
      height:100%;
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(900px 600px at 50% 0%, rgba(255,211,106,.28) 0%, rgba(255,211,106,0) 55%),
        radial-gradient(1200px 900px at 50% 10%, #6a101a 0%, var(--bg2) 38%, var(--bg1) 100%);
      overflow:hidden;
    }

    /* ===== PRELOADER ===== */
    #preloader{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:
        radial-gradient(900px 700px at 50% 30%, rgba(255,211,106,.22) 0%, rgba(255,211,106,0) 55%),
        radial-gradient(900px 700px at 50% 20%, #7b1220 0%, #2a0a10 55%, #120407 100%);
      z-index:9999;
    }
    .pre-card{
      width:min(520px, 92vw);
      padding:22px 18px 18px;
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.22));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      text-align:center;
    }
    .brand{
      display:flex; flex-direction:column; align-items:center; gap:10px;
      margin-bottom:14px;
    }
    .brand img{
      max-width:min(210px, 65vw);
      max-height:64px;
      object-fit:contain;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.55));
    }
    .brand .fallback{
      font-weight:900;
      letter-spacing:.8px;
      text-transform:uppercase;
      font-size:18px;
      opacity:.95;
    }
    .bar{
      height:14px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:#0b0406;
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, #ffd36a, #ffb84d, #ff5b6a);
      border-radius:999px;
      transition: width .12s ease;
    }
    .pct{
      margin-top:10px;
      font-size:13px;
      color:var(--muted);
      letter-spacing:.2px;
    }
    .hint{
      margin-top:8px;
      font-size:12px;
      color:#ffffffa6;
    }

    /* ===== STAGE ===== */
    #app{
      position:relative;
      width:100vw; height:100vh;
      display:flex; align-items:center; justify-content:center;
      padding:12px;
    }

    /* snow */
    #snowLayer{ position:absolute; inset:0; pointer-events:none; z-index:2; }

    #stage{
      position:relative;
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:1;
    }
    #santaBg{
      height: min(92vh, 980px);
      width:auto;
      max-width: 96vw;
      object-fit:contain;
      user-select:none;
      -webkit-user-drag:none;
      filter: drop-shadow(0 20px 40px rgba(0,0,0,.62));
    }

    /* renderer overlay */
    #gl{
      position:absolute;
      inset:0;
      pointer-events:auto;
      z-index:3;
    }

    /* UI top */
    .top-ui{
      position:absolute;
      top:14px; left:14px; right:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      z-index:4;
      pointer-events:none;
    }
    .pill{
      pointer-events:auto;
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.18));
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      font-size:13px;
      color:var(--muted);
      max-width:min(520px, 92vw);
    }
    .pill strong{ color:#fff; font-weight:900; }

    .btn{
      pointer-events:auto;
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.18));
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      letter-spacing:.2px;
      cursor:pointer;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      transition: transform .12s ease, border-color .12s ease, filter .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); border-color:#ffffff55; filter: brightness(1.05); }
    .btn:active{ transform: translateY(0px) scale(.99); }

    /* ===== MODAL ===== */
    #modal{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      z-index:9998;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(7px);
    }
    #modal.show{ display:flex; }
    .modal-card{
      width:min(520px, 92vw);
      border-radius:var(--radius);
      background:
        radial-gradient(700px 380px at 50% 0%, rgba(255,211,106,.18), rgba(255,211,106,0) 65%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.32));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      padding:18px 16px 14px;
    }
    .modal-title{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .modal-title h2{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .x{
      border:1px solid var(--stroke);
      background:transparent;
      color:#fff;
      width:36px; height:36px;
      border-radius:12px;
      cursor:pointer;
      font-size:18px;
    }
    .prize{
      margin-top:8px;
      padding:12px;
      border:1px solid #ffffff2a;
      border-radius:14px;
      background: rgba(0,0,0,.22);
    }
    .prize .big{
      font-size:18px;
      font-weight:900;
      color: #fff;
    }
    .prize .sub{
      margin-top:6px;
      font-size:13px;
      color:var(--muted);
      line-height:1.35;
    }
    .modal-actions{
      margin-top:12px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .btn-primary{
      background: linear-gradient(90deg, #ffd36a, #ffb84d, #ff5b6a);
      color:#24040b;
      border-color:transparent;
    }
    .btn-ghost{
      background:transparent;
      border:1px solid var(--stroke);
      color:#fff;
    }

    /* Mobile tweaks */
    @media (max-width: 420px){
      .pill{ font-size:12px; padding:9px 10px; }
      .btn{ padding:9px 10px; }
      #santaBg{ height: 90vh; }
    }

    /* reduce motion */
    @media (prefers-reduced-motion: reduce){
      .bar > div{ transition:none; }
      .btn{ transition:none; }
    }

    /* snow flakes */
    .flake{
      position:absolute;
      top:-10px;
      width:6px; height:6px;
      border-radius:999px;
      background: rgba(255,255,255,.88);
      box-shadow: 0 0 10px rgba(255,255,255,.35);
      opacity:.9;
      animation: fall linear infinite;
    }
    @keyframes fall{
      to{ transform: translateY(110vh); }
    }
  </style>
</head>

<body>
  <!-- PRELOADER -->
  <div id="preloader">
    <div class="pre-card">
      <div class="brand">
        <img id="brandLogo" src="assets/logo.png" alt="Logo"
             onerror="this.style.display='none'; document.getElementById('brandFallback').style.display='block';">
        <div id="brandFallback" class="fallback" style="display:none;">TU MARCA</div>
      </div>

      <div class="bar"><div id="barFill"></div></div>
      <div class="pct" id="pct">0%</div>
      <div class="hint">Cargando experiencia navide√±a‚Ä¶</div>
    </div>
  </div>

  <!-- MAIN -->
  <div id="app">
    <div id="snowLayer"></div>

    <div id="stage">
      <!-- IMPORTANTE: pon√© tu Santa en assets/santa.png -->
      <img id="santaBg" src="assets/santa.png" alt="Santa" draggable="false" />
      <div id="gl"></div>

      <div class="top-ui">
        <div class="pill" id="statusPill">
          üéÅ Eleg√≠ <strong>1 regalo</strong> (solo una vez)
        </div>
        <button class="btn" id="btnMyPrize" style="display:none;">Ver mi premio</button>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div id="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-title">
        <h2 id="modalTitle">¬°Felicidades! üéÑ</h2>
        <button class="x" id="modalClose" aria-label="Cerrar">‚úï</button>
      </div>

      <div class="prize">
        <div class="big" id="prizeBig">Premio</div>
        <div class="sub" id="prizeSub">Detalle</div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-ghost" id="btnReset" title="Solo para pruebas">Reset (test)</button>
        <button class="btn btn-primary" id="btnOk">Entendido</button>
      </div>
    </div>
  </div>

  <!-- Three.js -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script>
    // ========= CONFIG =========
    const STORAGE_KEY = "santa_gift_choice_v1";

    // Coordenadas NORMALIZADAS (0..1) sobre la imagen
    // Si los regalos quedan corridos, ajust√°s SOLO esto:
    const HAND_L = { x: 0.29, y: 0.52 };
    const HAND_R = { x: 0.71, y: 0.52 };

    // Premios fijos por regalo
    const PRIZES = {
      left: {
        title: "üéÅ Bono 200% en tu pr√≥xima carga",
        sub: "Se acredita en tu pr√≥xima carga. Consult√° condiciones con tu asesor."
      },
      right: {
        title: "üéÅ 3000 fichas gratis",
        sub: "Se activa con una carga m√≠nima de 5000. Consult√° condiciones con tu asesor."
      }
    };

    // ========= PRELOADER (FIX 99% + fallback) =========
    const preloader = document.getElementById("preloader");
    const barFill = document.getElementById("barFill");
    const pct = document.getElementById("pct");
    const santaImg = document.getElementById("santaBg");

    let progress = 0;

    function waitForImage(img, timeoutMs = 4500){
      return new Promise((resolve) => {
        // cache
        if (img.complete && img.naturalWidth > 0) return resolve(true);

        let done = false;
        const finish = (ok) => {
          if (done) return;
          done = true;
          cleanup();
          resolve(ok);
        };

        const onLoad = () => finish(true);
        const onErr  = () => finish(false);

        const cleanup = () => {
          img.removeEventListener("load", onLoad);
          img.removeEventListener("error", onErr);
          clearTimeout(t);
        };

        img.addEventListener("load", onLoad, { once:true });
        img.addEventListener("error", onErr, { once:true });

        const t = setTimeout(() => finish(false), timeoutMs);
      });
    }

    const imgPromise = waitForImage(santaImg, 5000);

    const pTimer = setInterval(() => {
      const step = (progress < 70) ? (Math.random()*10 + 6) : (Math.random()*4 + 1.5);
      progress = Math.min(99, progress + step);

      barFill.style.width = progress + "%";
      pct.textContent = Math.floor(progress) + "%";
    }, 120);

    Promise.race([
      imgPromise,
      new Promise(res => setTimeout(() => res(false), 5200))
    ]).then(() => {
      clearInterval(pTimer);
      barFill.style.width = "100%";
      pct.textContent = "100%";

      setTimeout(() => {
        preloader.style.display = "none";
        start();
      }, 350);
    });

    // ========= SNOW =========
    function spawnSnow(){
      const layer = document.getElementById("snowLayer");
      const count = 36;
      for(let i=0;i<count;i++){
        const f = document.createElement("div");
        f.className = "flake";
        const size = 3 + Math.random()*5;
        f.style.width = size + "px";
        f.style.height = size + "px";
        f.style.left = (Math.random()*100) + "vw";
        f.style.opacity = (0.35 + Math.random()*0.6).toFixed(2);
        const dur = 6 + Math.random()*10;
        f.style.animationDuration = dur + "s";
        f.style.animationDelay = (-Math.random()*dur) + "s";
        layer.appendChild(f);
      }
    }
    spawnSnow();

    // ========= MODAL =========
    const modal = document.getElementById("modal");
    const modalClose = document.getElementById("modalClose");
    const btnOk = document.getElementById("btnOk");
    const btnReset = document.getElementById("btnReset");
    const prizeBig = document.getElementById("prizeBig");
    const prizeSub = document.getElementById("prizeSub");
    const btnMyPrize = document.getElementById("btnMyPrize");
    const statusPill = document.getElementById("statusPill");

    function openModal(title, sub){
      prizeBig.textContent = title;
      prizeSub.textContent = sub;
      modal.classList.add("show");
      modal.setAttribute("aria-hidden","false");
    }
    function closeModal(){
      modal.classList.remove("show");
      modal.setAttribute("aria-hidden","true");
    }
    modalClose.onclick = closeModal;
    btnOk.onclick = closeModal;
    modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });

    btnReset.onclick = () => {
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    };

    // ========= THREE =========
    let scene, camera, renderer, raycaster, mouse;
    let giftLeft, giftRight;
    let W=0, H=0;
    let canPick = true;
    let anims = [];
    const glHost = document.getElementById("gl");

    function start(){
      initThree();
      updateUIFromStorage();
      animate();
      window.addEventListener("resize", onResize);
      window.addEventListener("orientationchange", () => setTimeout(onResize, 150));
      glHost.addEventListener("pointerdown", onPointerDown, { passive:false });
      btnMyPrize.addEventListener("click", showStoredPrize);
    }

    function initThree(){
      scene = new THREE.Scene();

      raycaster = new THREE.Raycaster();
      mouse = new THREE.Vector2();

      renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
      renderer.setPixelRatio(Math.min(2, window.devicePixelRatio || 1));
      renderer.setClearColor(0x000000, 0);
      glHost.appendChild(renderer.domElement);

      // luces suaves navide√±as (dorado c√°lido)
      const ambient = new THREE.AmbientLight(0xffffff, 0.82);
      scene.add(ambient);

      const dir = new THREE.DirectionalLight(0xffffff, 0.95);
      dir.position.set(300, 500, 600);
      scene.add(dir);

      const warm = new THREE.PointLight(0xffd36a, 0.95, 1200);
      warm.position.set(0, 120, 520);
      scene.add(warm);

      onResize();

      // regalos
      giftLeft  = createGift({ primary:0xff5b6a, ribbon:0xffd36a, id:"left"  }); // rojo + dorado
      giftRight = createGift({ primary:0x2fd6a0, ribbon:0xffffff, id:"right" }); // verde navidad (contraste)
      scene.add(giftLeft.group);
      scene.add(giftRight.group);

      positionGiftsToHands();
    }

    function onResize(){
      const rect = glHost.getBoundingClientRect();
      W = Math.max(1, Math.floor(rect.width));
      H = Math.max(1, Math.floor(rect.height));

      renderer.setSize(W, H, false);

      // c√°mara ortogr√°fica con unidades ‚Äúpixel‚Äù
      camera = new THREE.OrthographicCamera(
        -W/2, W/2, H/2, -H/2, -2000, 2000
      );
      camera.position.z = 900;

      positionGiftsToHands();
    }

    function positionGiftsToHands(){
      if(!giftLeft || !giftRight) return;

      const stageRect = document.getElementById("stage").getBoundingClientRect();
      const imgRect = santaImg.getBoundingClientRect();

      function handToWorld(norm){
        const px = imgRect.left + norm.x * imgRect.width;
        const py = imgRect.top  + norm.y * imgRect.height;

        const cx = px - stageRect.left;
        const cy = py - stageRect.top;

        const wx = (cx - W/2);
        const wy = (H/2 - cy);
        return { x: wx, y: wy };
      }

      const L = handToWorld(HAND_L);
      const R = handToWorld(HAND_R);

      const size = Math.min(W, H) * 0.14;
      const z = 220;

      giftLeft.group.position.set(L.x, L.y, z);
      giftRight.group.position.set(R.x, R.y, z);

      giftLeft.group.scale.setScalar(size);
      giftRight.group.scale.setScalar(size);

      giftLeft.group.rotation.set(0.08, -0.25, 0.02);
      giftRight.group.rotation.set(0.08,  0.25, -0.02);
    }

    function createGift({ primary, ribbon, id }){
      const group = new THREE.Group();
      group.userData.id = id;

      // caja
      const matBox = new THREE.MeshStandardMaterial({ color: primary, roughness:0.55, metalness:0.10 });
      const box = new THREE.Mesh(new THREE.BoxGeometry(1.0, 0.72, 1.0), matBox);
      box.position.y = 0.0;
      group.add(box);

      // cinta vertical
      const matRibbon = new THREE.MeshStandardMaterial({ color: ribbon, roughness:0.35, metalness:0.35 });
      const rib1 = new THREE.Mesh(new THREE.BoxGeometry(0.16, 0.74, 1.02), matRibbon);
      rib1.position.y = 0.01;
      group.add(rib1);

      // cinta horizontal
      const rib2 = new THREE.Mesh(new THREE.BoxGeometry(1.02, 0.16, 1.02), matRibbon);
      rib2.position.y = 0.20;
      group.add(rib2);

      // tapa con bisagra
      const lidPivot = new THREE.Group();
      lidPivot.position.set(0, 0.36, -0.52);
      group.add(lidPivot);

      const lid = new THREE.Mesh(new THREE.BoxGeometry(1.04, 0.20, 1.04), matBox);
      lid.position.set(0, 0.10, 0.52);
      lidPivot.add(lid);

      // mo√±o simple
      const bow1 = new THREE.Mesh(new THREE.TorusGeometry(0.18, 0.06, 10, 18, Math.PI), matRibbon);
      bow1.rotation.set(Math.PI/2, 0, 0);
      bow1.position.set(-0.16, 0.50, 0.12);
      group.add(bow1);

      const bow2 = bow1.clone();
      bow2.position.x = 0.16;
      group.add(bow2);

      // hitbox invisible
      const hit = new THREE.Mesh(
        new THREE.BoxGeometry(1.35, 1.0, 1.35),
        new THREE.MeshBasicMaterial({ transparent:true, opacity:0 })
      );
      hit.position.y = 0.20;
      hit.userData.isHit = true;
      hit.userData.parentGift = group;
      group.add(hit);

      return { group, lidPivot, isOpen:false, busy:false };
    }

    function onPointerDown(e){
      if(!canPick) return;
      e.preventDefault();

      // si ya jug√≥, tocar muestra premio
      const stored = getStored();
      if(stored){
        showStoredPrize();
        return;
      }

      const rect = renderer.domElement.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
      const y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
      mouse.set(x, y);

      raycaster.setFromCamera(mouse, camera);
      const hits = raycaster.intersectObjects(scene.children, true);
      if(!hits.length) return;

      const hit = hits.find(h => h.object?.userData?.isHit);
      if(!hit) return;

      const giftGroup = hit.object.userData.parentGift;
      const which = giftGroup.userData.id;
      pickGift(which);
    }

    function pickGift(which){
      const prize = PRIZES[which];
      if(!prize) return;

      canPick = false;
      statusPill.innerHTML = "üéÅ Abriendo regalo‚Ä¶";

      const giftObj = (which === "left") ? giftLeft : giftRight;
      openGiftAnim(giftObj, () => {
        setStored({ which, prize });
        updateUIFromStorage();
        openModal(prize.title, prize.sub);
      });
    }

    function openGiftAnim(giftObj, done){
      if(giftObj.busy) return;
      giftObj.busy = true;

      const start = performance.now();
      const dur = 900;

      const fromRot = giftObj.lidPivot.rotation.x;
      const toRot = -1.25;

      const fromS = giftObj.group.scale.x;
      const popS1 = fromS * 1.10;
      const popS2 = fromS * 1.00;

      anims.push((t)=>{
        const p = Math.min(1, (t - start) / dur);
        const ease = (p<0.5) ? (2*p*p) : (1 - Math.pow(-2*p+2,2)/2);

        giftObj.lidPivot.rotation.x = fromRot + (toRot - fromRot) * ease;

        let s;
        if(p < 0.35){
          const q = p / 0.35;
          s = fromS + (popS1 - fromS) * q;
        } else {
          const q = (p - 0.35) / 0.65;
          s = popS1 + (popS2 - popS1) * q;
        }
        giftObj.group.scale.setScalar(s);

        giftObj.group.rotation.y += 0.008;

        if(p >= 1){
          giftObj.isOpen = true;
          giftObj.busy = false;
          done && done();
          return false;
        }
        return true;
      });
    }

    function animate(t=performance.now()){
      requestAnimationFrame(animate);
      if(anims.length) anims = anims.filter(fn => fn(t) !== false);
      renderer.render(scene, camera);
    }

    // ========= STORAGE / UI =========
    function setStored(obj){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
    }
    function getStored(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      } catch { return null; }
    }

    function updateUIFromStorage(){
      const stored = getStored();
      if(stored){
        statusPill.innerHTML = "‚úÖ Ya elegiste tu regalo. <strong>¬°Felices fiestas!</strong>";
        btnMyPrize.style.display = "inline-flex";
        canPick = true; // permite tocar para ver premio
      } else {
        statusPill.innerHTML = "üéÅ Eleg√≠ <strong>1 regalo</strong> (solo una vez)";
        btnMyPrize.style.display = "none";
        canPick = true;
      }
    }

    function showStoredPrize(){
      const stored = getStored();
      if(!stored) return;
      openModal(stored.prize.title, stored.prize.sub);
    }
  </script>
</body>
</html>
