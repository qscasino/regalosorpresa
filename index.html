<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Regalos de Navidad</title>

  <style>
    :root{
      --bgA:#ffb39a;
      --bgB:#ff6c73;
      --bgC:#7c1b2c;
      --panel: rgba(20,10,14,.55);
      --stroke: rgba(255,255,255,.18);
      --text:#fff;
      --muted: rgba(255,255,255,.78);

      --gold:#ffd36a;
      --gold2:#ffb84d;
      --mint:#2fd6a0;

      --shadow: 0 22px 70px rgba(0,0,0,.45);
      --radius: 22px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{ box-sizing:border-box }
    html,body{
      height:100%;
      margin:0;
      font-family:var(--font);
      color:var(--text);
      overflow:hidden;
      background:
        radial-gradient(1200px 700px at 50% 12%, rgba(255,255,255,.16) 0%, rgba(255,255,255,0) 60%),
        radial-gradient(900px 650px at 20% 18%, rgba(255,211,106,.22) 0%, rgba(255,211,106,0) 55%),
        radial-gradient(900px 650px at 80% 22%, rgba(255,255,255,.16) 0%, rgba(255,255,255,0) 60%),
        radial-gradient(1200px 900px at 50% 0%, var(--bgA) 0%, var(--bgB) 40%, var(--bgC) 100%);
    }

    body::before{
      content:"";
      position:fixed; inset:-20%;
      pointer-events:none;
      background:
        radial-gradient(120px 120px at 10% 20%, rgba(255,211,106,.35) 0%, rgba(255,211,106,0) 60%),
        radial-gradient(160px 160px at 22% 62%, rgba(255,255,255,.22) 0%, rgba(255,255,255,0) 62%),
        radial-gradient(140px 140px at 86% 34%, rgba(255,211,106,.28) 0%, rgba(255,211,106,0) 60%),
        radial-gradient(190px 190px at 78% 78%, rgba(255,255,255,.18) 0%, rgba(255,255,255,0) 65%);
      filter: blur(2px);
      opacity:.9;
      transform: rotate(-2deg);
    }

    /* ===== PRELOADER ===== */
    #preloader{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      z-index:9999;
      background:
        radial-gradient(900px 700px at 50% 25%, rgba(255,211,106,.22) 0%, rgba(255,211,106,0) 55%),
        radial-gradient(1200px 900px at 50% 0%, rgba(255,179,154,.95) 0%, rgba(255,108,115,.92) 35%, rgba(124,27,44,.98) 100%);
    }
    .pre-card{
      width:min(560px, 92vw);
      padding:22px 18px 18px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(20,10,14,.56), rgba(0,0,0,.22));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(14px);
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .pre-card::after{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 50% 0%, rgba(255,211,106,.20), rgba(255,211,106,0) 60%);
      transform: rotate(8deg);
      pointer-events:none;
    }
    .brand{
      position:relative;
      display:flex; flex-direction:column; align-items:center; gap:10px;
      margin-bottom:14px;
    }
    .brand img{
      max-width:min(220px, 70vw);
      max-height:66px;
      object-fit:contain;
      filter: drop-shadow(0 12px 22px rgba(0,0,0,.45));
    }
    .brand .fallback{
      font-weight:900;
      letter-spacing:.9px;
      text-transform:uppercase;
      font-size:18px;
      opacity:.95;
    }
    .bar{
      position:relative;
      height:14px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.25);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.05);
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, #ffd36a, #ffb84d, #ff5b6a);
      border-radius:999px;
      transition: width .12s ease;
      will-change: width;
    }
    .pct{
      position:relative;
      margin-top:10px;
      font-size:13px;
      color:var(--muted);
      letter-spacing:.2px;
    }
    .hint{
      position:relative;
      margin-top:8px;
      font-size:12px;
      color:rgba(255,255,255,.80);
    }
    .err{
      position:relative;
      margin-top:10px;
      font-size:12px;
      color:rgba(255,255,255,.90);
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.14);
      padding:10px 10px;
      border-radius:14px;
      display:none;
      text-align:left;
      line-height:1.25;
    }
    .err.show{ display:block; }

    /* ===== STAGE ===== */
    #app{
      position:relative;
      width:100vw; height:100vh;
      display:flex; align-items:center; justify-content:center;
      padding:12px;
    }

    #snowLayer{ position:absolute; inset:0; pointer-events:none; z-index:2; }

    #stage{
      position:relative;
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:1;
    }

    #santaWrap{
      position:relative;
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px;
    }

    #santaBg{
      height: min(92vh, 980px);
      width:auto;
      max-width: 96vw;
      object-fit:contain;
      user-select:none;
      -webkit-user-drag:none;
      filter: drop-shadow(0 22px 50px rgba(0,0,0,.45));
      transform: translateZ(0);
    }

    /* renderer overlay */
    #gl{
      position:absolute;
      inset:0;
      pointer-events:auto;
      z-index:3;
    }

    /* UI top */
    .top-ui{
      position:absolute;
      top:14px; left:14px; right:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      z-index:4;
      pointer-events:none;
    }
    .pill{
      pointer-events:auto;
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background: linear-gradient(180deg, rgba(20,10,14,.45), rgba(0,0,0,.18));
      backdrop-filter: blur(14px);
      box-shadow: 0 14px 40px rgba(0,0,0,.25);
      font-size:13px;
      color:var(--muted);
      max-width:min(640px, 92vw);
    }
    .pill strong{ color:#fff; font-weight:900; }

    .btn{
      pointer-events:auto;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(20,10,14,.45), rgba(0,0,0,.18));
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      letter-spacing:.2px;
      cursor:pointer;
      box-shadow: 0 14px 40px rgba(0,0,0,.25);
      transition: transform .12s ease, border-color .12s ease, filter .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); border-color:rgba(255,255,255,.35); filter: brightness(1.05); }
    .btn:active{ transform: translateY(0px) scale(.99); }

    /* ===== MODAL ===== */
    #modal{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      z-index:9998;
      background: rgba(0,0,0,.58);
      backdrop-filter: blur(10px);
    }
    #modal.show{ display:flex; }
    .modal-card{
      width:min(560px, 92vw);
      border-radius:var(--radius);
      background:
        radial-gradient(700px 380px at 50% 0%, rgba(255,211,106,.22), rgba(255,211,106,0) 65%),
        linear-gradient(180deg, rgba(20,10,14,.60), rgba(0,0,0,.28));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      padding:18px 16px 14px;
    }
    .modal-title{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .modal-title h2{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .x{
      border:1px solid var(--stroke);
      background:transparent;
      color:#fff;
      width:36px; height:36px;
      border-radius:12px;
      cursor:pointer;
      font-size:18px;
    }
    .prize{
      margin-top:8px;
      padding:12px;
      border:1px solid rgba(255,255,255,.16);
      border-radius:16px;
      background: rgba(0,0,0,.18);
    }
    .prize .big{
      font-size:18px;
      font-weight:900;
      color:#fff;
      white-space:pre-wrap;
    }
    .prize .sub{
      margin-top:6px;
      font-size:13px;
      color:var(--muted);
      line-height:1.35;
      white-space:pre-wrap;
    }
    .modal-actions{
      margin-top:12px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .btn-primary{
      background: linear-gradient(90deg, #ffd36a, #ffb84d, #ff5b6a);
      color:#2a0a10;
      border-color:transparent;
    }
    .btn-ghost{
      background:transparent;
      border:1px solid var(--stroke);
      color:#fff;
    }

    @media (max-width: 420px){
      .pill{ font-size:12px; padding:9px 10px; }
      .btn{ padding:9px 10px; }
      #santaBg{ height: 90vh; }
    }

    @media (prefers-reduced-motion: reduce){
      .bar > div{ transition:none; }
      .btn{ transition:none; }
    }

    .flake{
      position:absolute;
      top:-10px;
      width:6px; height:6px;
      border-radius:999px;
      background: rgba(255,255,255,.85);
      box-shadow: 0 0 10px rgba(255,255,255,.28);
      opacity:.9;
      animation: fall linear infinite;
    }
    @keyframes fall{
      to{ transform: translateY(110vh); }
    }

    /* Debug markers */
    .dbg-dot{
      position:fixed;
      width:14px; height:14px;
      border-radius:999px;
      background: rgba(255,255,255,.95);
      box-shadow: 0 0 0 3px rgba(255,0,90,.35), 0 10px 22px rgba(0,0,0,.35);
      transform: translate(-50%, -50%);
      z-index: 9997;
      pointer-events:none;
    }
    .dbg-dot::after{
      content: attr(data-label);
      position:absolute;
      left:50%; top:-18px;
      transform: translateX(-50%);
      font-size:12px;
      font-weight:900;
      color:#fff;
      text-shadow: 0 6px 14px rgba(0,0,0,.55);
    }
  </style>
</head>

<body>
  <!-- PRELOADER -->
  <div id="preloader">
    <div class="pre-card">
      <div class="brand">
        <img id="brandLogo" src="assets/logo.png" alt="Logo"
             onerror="this.style.display='none'; document.getElementById('brandFallback').style.display='block';">
        <div id="brandFallback" class="fallback" style="display:none;">TU MARCA</div>
      </div>

      <div class="bar"><div id="barFill"></div></div>
      <div class="pct" id="pct">0%</div>
      <div class="hint" id="hint">Cargando experiencia navide√±a‚Ä¶</div>
      <div class="err" id="errBox"></div>
    </div>
  </div>

  <!-- MAIN -->
  <div id="app">
    <div id="snowLayer"></div>

    <div id="stage">
      <div id="santaWrap">
        <img id="santaBg" src="assets/santa.png" alt="Santa" draggable="false" />
        <div id="gl"></div>

        <div class="top-ui">
          <div class="pill" id="statusPill">üéÅ Eleg√≠ <strong>2 regalos</strong> (uno por mano)</div>
          <button class="btn" id="btnMyPrize" style="display:none;">Ver mis premios</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div id="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-title">
        <h2 id="modalTitle">¬°Felicidades! üéÑ</h2>
        <button class="x" id="modalClose" aria-label="Cerrar">‚úï</button>
      </div>

      <div class="prize">
        <div class="big" id="prizeBig">Premio</div>
        <div class="sub" id="prizeSub">Detalle</div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-ghost" id="btnReset" title="Solo para pruebas">Reset (test)</button>
        <button class="btn btn-primary" id="btnOk">Entendido</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    // =========================
    // 1) CONFIG ‚ÄúMEDIA‚Äù: PC vs CELU
    // =========================
    const STORAGE_KEY = "santa_gifts_two_v1";

    // üëâ Ajust√° AC√Å las manos para PC / CELU (0..1 sobre la imagen)
    const HANDS = {
      desktop: {
        left:  { x: 0.30, y: 0.50 },
        right: { x: 0.70, y: 0.50 }
      },
      mobile: {
        left:  { x: 0.30, y: 0.49 },
        right: { x: 0.70, y: 0.49 }
      }
    };

    // üëâ Ajust√° tama√±o por dispositivo (relativo al tama√±o del Santa)
    const SCALE = {
      desktop: 0.16,
      mobile:  0.18
    };

    // Premios (ejemplo)
    const PRIZES = {
      left:  { title: "üéÅ Bono 200% en tu pr√≥xima carga", sub: "Se acredita en tu pr√≥xima carga. Consult√° condiciones con tu asesor." },
      right: { title: "üéÅ 3000 fichas gratis",            sub: "Se activa con una carga m√≠nima de 5000. Consult√° condiciones con tu asesor." }
    };

    // =========================
    // 2) PRELOADER (99% fix)
    // =========================
    const preloader = document.getElementById("preloader");
    const barFill   = document.getElementById("barFill");
    const pctEl     = document.getElementById("pct");
    const hintEl    = document.getElementById("hint");
    const errBox    = document.getElementById("errBox");
    const santaImg  = document.getElementById("santaBg");

    let targetPct = 0;
    let visualPct = 0;
    let finishedBoot = false;

    function setTarget(p){ targetPct = Math.max(targetPct, Math.min(100, p)); }
    function renderPct(){
      visualPct += (targetPct - visualPct) * 0.14;
      const v = Math.floor(visualPct);
      barFill.style.width = v + "%";
      pctEl.textContent = v + "%";
      if(!finishedBoot) requestAnimationFrame(renderPct);
    }

    function showErr(msg){
      errBox.textContent = msg;
      errBox.classList.add("show");
    }

    function ensureImageLoaded(img, timeoutMs=6000){
      return new Promise((resolve) => {
        if(!img || !img.src) return resolve(false);
        if(img.complete) return resolve(img.naturalWidth > 0);

        let done = false;
        const t = setTimeout(() => finish(false), timeoutMs);

        function finish(ok){
          if(done) return;
          done = true;
          clearTimeout(t);
          img.removeEventListener("load", onLoad);
          img.removeEventListener("error", onErr);
          resolve(ok);
        }
        function onLoad(){ finish(true); }
        function onErr(){ finish(false); }

        img.addEventListener("load", onLoad, { once:true });
        img.addEventListener("error", onErr, { once:true });
      });
    }

    function loadScript(src, timeoutMs=7000){
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src;
        s.async = true;

        let done = false;
        const t = setTimeout(() => {
          if(done) return;
          done = true;
          s.remove();
          reject(new Error("timeout " + src));
        }, timeoutMs);

        s.onload = () => {
          if(done) return;
          done = true;
          clearTimeout(t);
          resolve(true);
        };
        s.onerror = () => {
          if(done) return;
          done = true;
          clearTimeout(t);
          s.remove();
          reject(new Error("error " + src));
        };

        document.head.appendChild(s);
      });
    }

    async function ensureThree(){
      if(window.THREE) return true;
      const cdns = [
        "https://unpkg.com/three@0.160.0/build/three.min.js",
        "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"
      ];
      for(const url of cdns){
        try{
          hintEl.textContent = "Cargando motor 3D‚Ä¶";
          await loadScript(url, 7000);
          if(window.THREE) return true;
        } catch(e){}
      }
      return false;
    }

    async function boot(){
      setTarget(8);
      requestAnimationFrame(renderPct);

      let done = 0;
      const total = 2;
      const step = () => { done++; setTarget(Math.round((done/total)*92)); };

      hintEl.textContent = "Cargando Santa‚Ä¶";
      const okSanta = await ensureImageLoaded(santaImg, 6500);
      step();

      const okThree = await ensureThree();
      step();

      const warns = [];
      if(!okSanta) warns.push("No se pudo cargar assets/santa.png.");
      if(!okThree) warns.push("No se pudo cargar Three.js (revis√° conexi√≥n/CSP).");
      if(warns.length) showErr("‚ö†Ô∏è " + warns.join(" "));

      setTarget(100);
      finishedBoot = true;
      barFill.style.width = "100%";
      pctEl.textContent = "100%";

      setTimeout(() => {
        preloader.style.display = "none";
        if(okThree) start();
      }, 220);
    }

    boot();

    // =========================
    // 3) Snow
    // =========================
    function spawnSnow(){
      const layer = document.getElementById("snowLayer");
      const count = 38;
      for(let i=0;i<count;i++){
        const f = document.createElement("div");
        f.className = "flake";
        const size = 3 + Math.random()*5;
        f.style.width = size + "px";
        f.style.height = size + "px";
        f.style.left = (Math.random()*100) + "vw";
        f.style.opacity = (0.30 + Math.random()*0.6).toFixed(2);
        const dur = 6 + Math.random()*11;
        f.style.animationDuration = dur + "s";
        f.style.animationDelay = (-Math.random()*dur) + "s";
        layer.appendChild(f);
      }
    }
    spawnSnow();

    // =========================
    // 4) Modal
    // =========================
    const modal = document.getElementById("modal");
    const modalClose = document.getElementById("modalClose");
    const btnOk = document.getElementById("btnOk");
    const btnReset = document.getElementById("btnReset");
    const prizeBig = document.getElementById("prizeBig");
    const prizeSub = document.getElementById("prizeSub");
    const btnMyPrize = document.getElementById("btnMyPrize");
    const statusPill = document.getElementById("statusPill");

    function openModal(title, sub){
      prizeBig.textContent = title;
      prizeSub.textContent = sub;
      modal.classList.add("show");
      modal.setAttribute("aria-hidden","false");
    }
    function closeModal(){
      modal.classList.remove("show");
      modal.setAttribute("aria-hidden","true");
    }
    modalClose.onclick = closeModal;
    btnOk.onclick = closeModal;
    modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });

    btnReset.onclick = () => {
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    };

    // =========================
    // 5) Storage (2 picks)
    // =========================
    function getStored(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return { left:null, right:null };
        const obj = JSON.parse(raw);
        return {
          left: obj.left || null,
          right: obj.right || null
        };
      } catch {
        return { left:null, right:null };
      }
    }
    function setStored(next){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
    }
    function pickedCount(){
      const s = getStored();
      return (s.left ? 1 : 0) + (s.right ? 1 : 0);
    }

    function updateUI(){
      const s = getStored();
      const count = pickedCount();

      if(count === 0){
        statusPill.innerHTML = "üéÅ Eleg√≠ <strong>2 regalos</strong> (uno por mano)";
        btnMyPrize.style.display = "none";
      } else if(count === 1){
        statusPill.innerHTML = "üéÅ Elegiste <strong>1/2</strong>. Te queda <strong>1 regalo</strong>.";
        btnMyPrize.style.display = "inline-flex";
      } else {
        statusPill.innerHTML = "‚úÖ Ya elegiste tus <strong>2 regalos</strong>. <strong>¬°Felices fiestas!</strong>";
        btnMyPrize.style.display = "inline-flex";
      }
    }

    function showStoredPrizes(){
      const s = getStored();
      const lines = [];
      const subs = [];

      if(s.left){
        lines.push("üü• Mano izquierda: " + s.left.prize.title);
        subs.push(s.left.prize.sub);
      }
      if(s.right){
        lines.push("üü© Mano derecha: " + s.right.prize.title);
        subs.push(s.right.prize.sub);
      }
      if(!lines.length) return;

      openModal(lines.join("\n"), subs.join("\n\n"));
    }

    btnMyPrize.addEventListener("click", showStoredPrizes);

    // =========================
    // 6) THREE + Anclaje ultra estable
    // =========================
    let scene, camera, renderer, raycaster, mouse;
    let giftLeft, giftRight;
    let W=0, H=0;
    let anims = [];
    let busyPick = false;

    const glHost = document.getElementById("gl");
    const isDebug = new URLSearchParams(location.search).get("debug") === "1";
    let dbgL = null, dbgR = null;

    function isMobile(){
      return window.matchMedia && window.matchMedia("(max-width: 520px)").matches;
    }
    function handsForViewport(){
      return isMobile() ? HANDS.mobile : HANDS.desktop;
    }
    function scaleForViewport(){
      return isMobile() ? SCALE.mobile : SCALE.desktop;
    }

    // Scheduler para recalcular varias veces (soluciona ‚Äúcambio de pantalla‚Äù)
    let layoutRAF = 0;
    let layoutPending = false;
    function scheduleLayout(){
      if(layoutPending) return;
      layoutPending = true;
      layoutRAF = requestAnimationFrame(() => {
        layoutPending = false;
        onResize();
      });
    }

    function start(){
      initThree();
      updateUI();

      // listeners robustos
      window.addEventListener("resize", scheduleLayout);
      window.addEventListener("orientationchange", () => setTimeout(scheduleLayout, 160));
      window.visualViewport?.addEventListener("resize", scheduleLayout);
      window.visualViewport?.addEventListener("scroll", scheduleLayout);

      // Observa cambios reales de tama√±o (PC y m√≥vil)
      try{
        const ro = new ResizeObserver(() => scheduleLayout());
        ro.observe(glHost);
        ro.observe(santaImg);
      } catch {}

      // recalibra varias veces al inicio (por el ‚Äúlayout settle‚Äù del m√≥vil)
      setTimeout(scheduleLayout, 80);
      setTimeout(scheduleLayout, 220);
      setTimeout(scheduleLayout, 520);
      setTimeout(scheduleLayout, 900);

      animate();
    }

    function initThree(){
      scene = new THREE.Scene();
      raycaster = new THREE.Raycaster();
      mouse = new THREE.Vector2();

      renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
      renderer.setPixelRatio(Math.min(2, window.devicePixelRatio || 1));
      renderer.setClearColor(0x000000, 0);
      renderer.domElement.style.position = "absolute";
      renderer.domElement.style.inset = "0";
      renderer.domElement.style.touchAction = "manipulation";
      glHost.appendChild(renderer.domElement);

      // Match look cute
      renderer.outputColorSpace = THREE.SRGBColorSpace;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.05;

      scene.add(new THREE.AmbientLight(0xffffff, 0.80));
      scene.add(new THREE.HemisphereLight(0xfff0df, 0x2a0a10, 0.55));

      const key = new THREE.DirectionalLight(0xffffff, 0.85);
      key.position.set(300, 520, 620);
      scene.add(key);

      const warm = new THREE.PointLight(0xffd36a, 1.05, 1400);
      warm.position.set(0, 140, 580);
      scene.add(warm);

      const rim = new THREE.PointLight(0xffffff, 0.55, 1200);
      rim.position.set(-420, 240, 420);
      scene.add(rim);

      giftLeft  = createGift({ primary:0xff5b6a, ribbon:0xffd36a, id:"left"  });
      giftRight = createGift({ primary:0x2fd6a0, ribbon:0xffffff, id:"right" });

      scene.add(giftLeft.group, giftRight.group);

      scheduleLayout();

      renderer.domElement.addEventListener("pointerdown", onPointerDown, { passive:false });

      if(isDebug){
        dbgL = document.createElement("div");
        dbgL.className = "dbg-dot";
        dbgL.dataset.label = "L";
        document.body.appendChild(dbgL);

        dbgR = document.createElement("div");
        dbgR.className = "dbg-dot";
        dbgR.dataset.label = "R";
        document.body.appendChild(dbgR);
      }
    }

    function onResize(){
      const rect = glHost.getBoundingClientRect();
      W = Math.max(1, Math.floor(rect.width));
      H = Math.max(1, Math.floor(rect.height));

      renderer.setSize(W, H, false);

      if(!camera){
        camera = new THREE.OrthographicCamera(-W/2, W/2, H/2, -H/2, -2000, 2000);
        camera.position.z = 900;
      } else {
        camera.left = -W/2;
        camera.right = W/2;
        camera.top = H/2;
        camera.bottom = -H/2;
        camera.updateProjectionMatrix();
      }

      // recalcula manos 1 frame despu√©s (por layout de img)
      requestAnimationFrame(positionGiftsToHands);
    }

    function positionGiftsToHands(){
      if(!giftLeft || !giftRight) return;

      const imgRect = santaImg.getBoundingClientRect();
      const ovRect  = glHost.getBoundingClientRect();
      if(imgRect.width < 10 || imgRect.height < 10 || ovRect.width < 10 || ovRect.height < 10) return;

      const hands = handsForViewport();
      const giftScale = scaleForViewport();

      const toWorld = (norm) => {
        const px = imgRect.left + norm.x * imgRect.width;
        const py = imgRect.top  + norm.y * imgRect.height;

        const lx = px - ovRect.left;
        const ly = py - ovRect.top;

        const wx = lx - (W/2);
        const wy = (H/2) - ly;
        return { x: wx, y: wy, px, py };
      };

      const L = toWorld(hands.left);
      const R = toWorld(hands.right);

      const size = Math.min(imgRect.width, imgRect.height) * giftScale;
      const z = 320;

      giftLeft.group.position.set(L.x, L.y, z);
      giftRight.group.position.set(R.x, R.y, z);

      giftLeft.group.scale.setScalar(size);
      giftRight.group.scale.setScalar(size);

      giftLeft.group.rotation.set(0.10, -0.30, 0.02);
      giftRight.group.rotation.set(0.10,  0.30, -0.02);

      if(isDebug && dbgL && dbgR){
        dbgL.style.left = L.px + "px";
        dbgL.style.top  = L.py + "px";
        dbgR.style.left = R.px + "px";
        dbgR.style.top  = R.py + "px";
      }
    }

    function createGift({ primary, ribbon, id }){
      const group = new THREE.Group();
      group.userData.id = id;

      const matBox = new THREE.MeshPhysicalMaterial({
        color: primary,
        roughness: 0.35,
        metalness: 0.05,
        clearcoat: 0.35,
        clearcoatRoughness: 0.45
      });

      const matRibbon = new THREE.MeshPhysicalMaterial({
        color: ribbon,
        roughness: 0.25,
        metalness: 0.15,
        clearcoat: 0.25,
        clearcoatRoughness: 0.30
      });

      const box = new THREE.Mesh(new THREE.BoxGeometry(1.0, 0.72, 1.0), matBox);
      group.add(box);

      const rib1 = new THREE.Mesh(new THREE.BoxGeometry(0.16, 0.74, 1.02), matRibbon);
      rib1.position.y = 0.01;
      group.add(rib1);

      const rib2 = new THREE.Mesh(new THREE.BoxGeometry(1.02, 0.16, 1.02), matRibbon);
      rib2.position.y = 0.20;
      group.add(rib2);

      const lidPivot = new THREE.Group();
      lidPivot.position.set(0, 0.36, -0.52);
      group.add(lidPivot);

      const lid = new THREE.Mesh(new THREE.BoxGeometry(1.04, 0.20, 1.04), matBox);
      lid.position.set(0, 0.10, 0.52);
      lidPivot.add(lid);

      const bow1 = new THREE.Mesh(new THREE.TorusGeometry(0.18, 0.06, 10, 18, Math.PI), matRibbon);
      bow1.rotation.set(Math.PI/2, 0, 0);
      bow1.position.set(-0.16, 0.50, 0.12);
      group.add(bow1);

      const bow2 = bow1.clone();
      bow2.position.x = 0.16;
      group.add(bow2);

      const hit = new THREE.Mesh(
        new THREE.BoxGeometry(1.35, 1.0, 1.35),
        new THREE.MeshBasicMaterial({ transparent:true, opacity:0 })
      );
      hit.position.y = 0.20;
      hit.userData.isHit = true;
      hit.userData.parentGift = group;
      group.add(hit);

      return { group, lidPivot, busy:false };
    }

    function onPointerDown(e){
      e.preventDefault();
      if(busyPick) return;

      // si tocan donde no hay regalo, no hace nada
      const rect = renderer.domElement.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
      const y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
      mouse.set(x, y);

      raycaster.setFromCamera(mouse, camera);
      const hits = raycaster.intersectObjects(scene.children, true);
      if(!hits.length) return;

      const hit = hits.find(h => h.object?.userData?.isHit);
      if(!hit) return;

      const giftGroup = hit.object.userData.parentGift;
      const which = giftGroup.userData.id; // "left" | "right"
      pickGift(which);
    }

    function pickGift(which){
      const stored = getStored();

      // Si esa mano ya fue elegida => mostrar premio de esa mano
      if(stored[which]){
        openModal(stored[which].prize.title, stored[which].prize.sub);
        return;
      }

      // Si no fue elegida => abrir y guardar
      const prize = PRIZES[which];
      if(!prize) return;

      busyPick = true;

      const giftObj = (which === "left") ? giftLeft : giftRight;
      openGiftAnim(giftObj, () => {
        try{
          confetti({ particleCount: 120, spread: 70, origin: { y: 0.55 }, scalar: 0.9, ticks: 180 });
        } catch {}

        const next = getStored();
        next[which] = { prize };
        setStored(next);

        updateUI();
        openModal(prize.title, prize.sub);

        busyPick = false;
      });
    }

    function openGiftAnim(giftObj, done){
      if(giftObj.busy) return;
      giftObj.busy = true;

      const start = performance.now();
      const dur = 900;

      const fromRot = giftObj.lidPivot.rotation.x;
      const toRot = -1.25;

      const fromS = giftObj.group.scale.x;
      const popS1 = fromS * 1.12;
      const popS2 = fromS * 1.00;

      anims.push((t)=>{
        const p = Math.min(1, (t - start) / dur);
        const ease = (p<0.5) ? (2*p*p) : (1 - Math.pow(-2*p+2,2)/2);

        giftObj.lidPivot.rotation.x = fromRot + (toRot - fromRot) * ease;

        let s;
        if(p < 0.35){
          const q = p / 0.35;
          s = fromS + (popS1 - fromS) * q;
        } else {
          const q = (p - 0.35) / 0.65;
          s = popS1 + (popS2 - popS1) * q;
        }
        giftObj.group.scale.setScalar(s);

        giftObj.group.rotation.y += 0.010;

        if(p >= 1){
          giftObj.busy = false;
          done && done();
          return false;
        }
        return true;
      });
    }

    function animate(t=performance.now()){
      requestAnimationFrame(animate);
      if(anims.length) anims = anims.filter(fn => fn(t) !== false);
      renderer.render(scene, camera);
    }
  </script>
</body>
</html>
